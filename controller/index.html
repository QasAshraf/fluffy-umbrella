<script src="./caffeine.min.js"></script>
<link rel="stylesheet" href="/foundation.min.css" />
<div class="row">
    <div class="small-4 large-4 columns"><img src="arrow.png" style="
    transform: rotate(90deg);
    margin-top: 150px;"></div>
    <div class="small-4 large-4 columns">
        <h1 id="playText" style="
        line-height: 370px;
        vertical-align: middle;
        margin-top: 50px;
        ">Rotate to play</h1>
        <h1 id="restart" style="
        line-height: 370px;
        vertical-align: middle;
        margin-top: 50px;
        display: none;
        ">Restart</h1>
    </div>
    <div class="small-4 large-4 columns"><img src="arrow.png" style="
    transform: rotate(270deg);
    margin-top: 150px;"></div>
</div>

<script src="/socket.io.js"></script>
<script src="/NoSleep.min.js"></script>
<script>
    var socket = io();
    var lastData;

    socket.on('serverBroadcast', function(msg){
        console.log(msg);
    });

    var lastData = {
        "id" : socket.id,
        "name" : "Dave"
    };

    socket.emit('controllerData', lastData);

    // Server tells user they have crashed
    socket.on('controllerRestart', function (msg) {
        console.log(msg)
        document.getElementById('playText').style.display = "none"
        document.getElementById('restart').style.display = "block"
    })

    var button = document.getElementById('restart')
    button.addEventListener('click', function (e) {
        socket.emit('playerTriedToRestart', lastData)
        document.getElementById('playText').style.display = "initial"
        document.getElementById('restart').style.display = "none"
    })

    if(window.DeviceMotionEvent){
        window.addEventListener("devicemotion", motion, false);
    }else{
        console.log("DeviceMotionEvent is not supported");
    }

    window.setInterval(updateServer, 100);

    function motion(event) {

        if(event.accelerationIncludingGravity.x == null)
            return;

        lastData = {
            "id": socket.id,
            "name": "Dave",
            "accelX": event.accelerationIncludingGravity.x,
            "accelY": event.accelerationIncludingGravity.y,
            "accelZ": event.accelerationIncludingGravity.z,
        };
    }

    function sendSpoofMotion(dir) {
        if(dir == 'left') {
            lastData = {
                "id": socket.id,
                "name": "Dave",
                "accelX": 0,
                "accelY": -10,
                "accelZ": 0,
            }
        } else {
            lastData = {
                "id": socket.id,
                "name": "Dave",
                "accelX": 0,
                "accelY": 10,
                "accelZ": 0,
            }
        }
    }

    $(document).keydown(function(e) {
        switch(e.which) {
            case 37: // left
                sendSpoofMotion('left')
                break;

            case 38: // up
                break;

            case 39: // right
                sendSpoofMotion('right')
                break;

            case 40: // down
                break;

            default: return; // exit this handler for other keys
        }
        e.preventDefault(); // prevent the default action (scroll / move caret)
    });

    function updateServer(){
        socket.emit('controllerData', lastData);
    }

    //Lets stop the screen going off as we loose our controller connection
    var noSleep = new NoSleep();

    function enableNoSleep() {
        noSleep.enable();
        document.removeEventListener('touchstart', enableNoSleep, false);
    }

    // Enable wake lock.
    // (must be wrapped in a user input event handler e.g. a mouse or touch handler)
    document.addEventListener('touchstart', enableNoSleep, false);

</script>
